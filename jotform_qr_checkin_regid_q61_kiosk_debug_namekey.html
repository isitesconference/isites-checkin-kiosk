<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Conference QR Check-In (REG ID → Q61 “checkin”, Debug name-key)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- QR scanner library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0b1020;
      color: #f5f5f5;
    }
    header {
      background: #101936;
      color: #fff;
      padding: 14px 20px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    header span.sub {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.8;
    }
    .container {
      display: flex;
      gap: 16px;
      padding: 16px;
      flex-wrap: wrap;
    }
    .panel {
      background: #141b33;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.6);
    }
    .left {
      flex: 2;
      min-width: 320px;
    }
    .right {
      flex: 1;
      min-width: 260px;
      max-width: 380px;
    }
    h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    h2 .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #1f3a93;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    #status {
      margin-top: 8px;
      font-size: 13px;
      min-height: 18px;
    }
    #status.ok {
      color: #7cffc1;
    }
    #status.error {
      color: #ff7b88;
    }
    .small {
      font-size: 11px;
      color: #c0c6e0;
      margin-top: 6px;
    }
    #qr-reader {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }
    .stat-block {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 6px;
      background: #1a2344;
      font-size: 13px;
    }
    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.7;
      margin-bottom: 2px;
    }
    .stat-value {
      font-weight: 600;
      word-break: break-word;
    }
    .log-entry {
      font-size: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 4px 0;
    }
    .log-time {
      color: #a4aadb;
      margin-right: 4px;
    }
    .log-name {
      font-weight: 600;
      color: #e6e9ff;
    }
    .pill-ok {
      display: inline-block;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(124,255,193,0.1);
      color: #7cffc1;
      border: 1px solid rgba(124,255,193,0.4);
      margin-left: 4px;
    }
    .pill-dupe {
      display: inline-block;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(255,190,92,0.1);
      color: #ffbe5c;
      border: 1px solid rgba(255,190,92,0.4);
      margin-left: 4px;
    }
    .debug-block {
      margin-top: 12px;
      font-size: 11px;
    }
    .debug-block textarea {
      width: 100%;
      min-height: 160px;
      border-radius: 6px;
      border: 1px solid #2b3358;
      background: #050814;
      color: #d5dbff;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      padding: 6px;
      box-sizing: border-box;
    }
    footer {
      text-align: center;
      font-size: 10px;
      color: #7d84b3;
      padding: 6px 0 10px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      ISITES Conference – QR Check-In
      <span class="sub">REG ID (Q41) → Check-In (Q61 “checkin” = “checked”) · Debug name-key</span>
    </div>
    <span style="font-size:11px;opacity:.7;">Kiosk + Debug</span>
  </header>

  <div class="container">
    <!-- Scanner panel -->
    <div class="panel left">
      <h2>
        Scanner
        <span class="tag">Live</span>
      </h2>
      <div id="qr-reader"></div>
      <div id="status"></div>
      <div class="small">
        • QR contains <b>REG ID</b> as first number before <code>+</code>.<br />
        • Example: <code>12345+ISITES</code> → we use <b>12345</b>.<br />
        • REG ID → Jotform field <b>Q41</b>; Check-In is the Short Text field with<br />
          <code>qid = 61</code>, <code>name = "checkin"</code> → we update via <code>submission[checkin]</code>.
      </div>
    </div>

    <!-- Info + log + debug panel -->
    <div class="panel right">
      <h2>
        Last Check-In
        <span class="tag">Summary</span>
      </h2>
      <div id="lastCheckin">
        <div class="small">No check-ins yet. Scan a badge to begin.</div>
      </div>

      <h2 style="margin-top:18px;">
        Recent Activity
        <span class="tag">Log</span>
      </h2>
      <div id="log"></div>

      <div class="debug-block">
        <div class="stat-label">Debug – Last API Response Snapshot (including Q61 / name="checkin")</div>
        <textarea id="debugOutput" readonly>Nothing yet. After scanning, this will show the stored value for Q61 / "checkin".</textarea>
      </div>
    </div>
  </div>

  <footer>
    This version sends submission[checkin] and then reads back the submission to show what Jotform stored.
  </footer>

  <script>
    // ======== EMBEDDED CONFIG (KIOSK MODE) ========
    const EMBEDDED_API_KEY = "509a7d88f82e8cca3c3fd857cd99ed2e";
    const FORM_ID = "252042760242144";   // Your Jotform form ID
    const REG_QID = "41";                // REG ID field (q41)
    const CHECKIN_QID = "61";            // Check-In field q61 (numeric id)
    const CHECKIN_NAME = "checkin";      // Check-In field name from API
    const TIME_QID = "";                 // Optional: set to e.g. "62" if you add a timestamp field
    const CHECKIN_VALUE = "checked";     // value to write

    const statusEl = document.getElementById("status");
    const lastCheckinEl = document.getElementById("lastCheckin");
    const logEl = document.getElementById("log");
    const debugOutputEl = document.getElementById("debugOutput");

    function showStatus(message, type = "") {
      statusEl.textContent = message;
      statusEl.className = type ? type : "";
    }

    function addLogEntry(data) {
      const div = document.createElement("div");
      div.className = "log-entry";
      const now = new Date();
      const time = now.toLocaleTimeString();
      const pill = data.duplicate ? '<span class="pill-dupe">Already Checked</span>' : '<span class="pill-ok">Checked</span>';
      div.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-name">${data.name || "Unknown Name"}</span>
        &mdash; ${data.email || "No email"} (REG ID: ${data.registrationId}) ${pill}
      `;
      logEl.prepend(div);
    }

    function showLastCheckin(data) {
      lastCheckinEl.innerHTML = `
        <div class="stat-block">
          <div class="stat-label">Name</div>
          <div class="stat-value">${data.name || "Unknown"}</div>
        </div>
        <div class="stat-block">
          <div class="stat-label">Email</div>
          <div class="stat-value">${data.email || "Unknown"}</div>
        </div>
        <div class="stat-block">
          <div class="stat-label">REG ID</div>
          <div class="stat-value">${data.registrationId}</div>
        </div>
        <div class="stat-block">
          <div class="stat-label">Submission ID</div>
          <div class="stat-value">${data.submissionId}</div>
        </div>
        <div class="stat-block">
          <div class="stat-label">Status</div>
          <div class="stat-value">
            ${data.statusText}
            ${data.duplicate ? '<span class="pill-dupe">Duplicate Scan</span>' : '<span class="pill-ok">Checked</span>'}
          </div>
        </div>
      `;
    }

    function updateDebugOutput(text) {
      debugOutputEl.value = text;
    }

    // ======== JOTFORM API HELPERS ========

    async function findSubmissionByRegistrationId(regId) {
      const fieldName = "q" + REG_QID;
      const filterObj = {};
      filterObj[fieldName] = regId;
      const filterStr = encodeURIComponent(JSON.stringify(filterObj));

      const url = `https://api.jotform.com/form/${FORM_ID}/submissions?apiKey=${encodeURIComponent(EMBEDDED_API_KEY)}&filter=${filterStr}`;

      const res = await fetch(url);
      if (!res.ok) {
        throw new Error("Failed to search submissions (" + res.status + ")");
      }
      const json = await res.json();
      if (!json.content || !Array.isArray(json.content) || json.content.length === 0) {
        throw new Error("No submission found for REG ID: " + regId);
      }
      return json.content[0];
    }

    async function markCheckedIn(submissionId) {
      const url = `https://api.jotform.com/submission/${submissionId}?apiKey=${encodeURIComponent(EMBEDDED_API_KEY)}`;
      const params = new URLSearchParams();

      // Use the field's "name" from Jotform ("checkin"):
      // submission[checkin] = "checked"
      params.append(`submission[${CHECKIN_NAME}]`, CHECKIN_VALUE);

      if (TIME_QID) {
        const nowIso = new Date().toISOString();
        params.append(`submission[q${TIME_QID}]`, nowIso);
      }

      const res = await fetch(url, {
        method: "POST",
        body: params
      });

      const text = await res.text();
      if (!res.ok) {
        console.error("Update error response:", text);
        updateDebugOutput(
          "Update error from Jotform:\n\nHTTP " + res.status + "\n\n" + text
        );
        throw new Error("Failed to update submission: " + res.status);
      }

      updateDebugOutput(
        "Update response from Jotform:\n" +
        "(Raw response to the POST update call)\n\n" +
        text
      );

      return true;
    }

    async function fetchSubmissionById(submissionId) {
      const url = `https://api.jotform.com/submission/${submissionId}?apiKey=${encodeURIComponent(EMBEDDED_API_KEY)}`;
      const res = await fetch(url);
      const text = await res.text();

      let parsed;
      try {
        parsed = JSON.parse(text);
      } catch (e) {
        updateDebugOutput(
          "Failed to parse submission fetch response as JSON.\n\nRaw response:\n" + text
        );
        return null;
      }

      const answers = parsed.content && parsed.content.answers ? parsed.content.answers : {};
      const byQid = answers[CHECKIN_QID];
      // Also look through all answers to find any field with name === "checkin"
      let byName = null;
      for (const key of Object.keys(answers)) {
        const ans = answers[key];
        if (ans && ans.name === CHECKIN_NAME) {
          byName = ans;
          break;
        }
      }

      updateDebugOutput(
        "Fetched submission after update:\n" +
        `Submission ID: ${submissionId}\n` +
        `By QID (61) raw answer: ${
          byQid && typeof byQid.answer !== "undefined"
            ? JSON.stringify(byQid.answer)
            : "(no value / field not found for qid 61)"
        }\n` +
        `By name ("${CHECKIN_NAME}") raw answer: ${
          byName && typeof byName.answer !== "undefined"
            ? JSON.stringify(byName.answer)
            : "(no value / field not found for name 'checkin')"
        }\n\nFull snippet:\n` +
        JSON.stringify(
          {
            id: parsed.content && parsed.content.id,
            byQid,
            byName
          },
          null,
          2
        )
      );

      return parsed;
    }

    function extractBasicInfo(submission) {
      let name = "";
      let email = "";
      let alreadyChecked = false;

      const answers = submission.answers || {};
      for (const key of Object.keys(answers)) {
        const ans = answers[key];
        if (!ans) continue;

        if (!name && ans.name && ans.answer) {
          if (typeof ans.answer === "object") {
            const parts = [];
            if (ans.answer.first) parts.push(ans.answer.first);
            if (ans.answer.last) parts.push(ans.answer.last);
            name = parts.join(" ");
          } else {
            name = String(ans.answer);
          }
        }
        if (!email && ans.type === "control_email" && ans.answer) {
          email = ans.answer;
        }

        // Check Q61 / "checkin" value
        if (key === CHECKIN_QID || ans.name === CHECKIN_NAME) {
          const val = (ans.answer || "").toString().toLowerCase().trim();
          if (val === CHECKIN_VALUE.toLowerCase()) {
            alreadyChecked = true;
          }
        }
      }

      return {
        name: name || submission.pretty || "",
        email,
        alreadyChecked
      };
    }

    // ======== QR SCANNER LOGIC ========

    function onScanSuccess(decodedText, decodedResult) {
      const raw = decodedText.trim();
      const registrationId = raw.split("+")[0].trim();  // first token before '+'

      console.log("QR decoded raw:", raw, "→ REG ID parsed:", registrationId);

      if (!registrationId) {
        showStatus("Error: Could not parse REG ID from QR value: " + raw, "error");
        return;
      }

      showStatus(`Scanning… REG ID: ${registrationId}`);
      updateDebugOutput("Running check-in flow for REG ID: " + registrationId + "…");

      processCheckInByRegId(registrationId)
        .catch(err => {
          console.error(err);
          showStatus("Error: " + err.message, "error");
          updateDebugOutput("Error during check-in:\n" + err.message);
        });
    }

    async function processCheckInByRegId(registrationId) {
      // 1) Find submission by REG ID
      const submission = await findSubmissionByRegistrationId(registrationId);
      const submissionId = submission.id;
      const info = extractBasicInfo(submission);

      const wasAlreadyChecked = info.alreadyChecked;

      // 2) Force checkin = "checked" using field name
      await markCheckedIn(submissionId);

      // 3) Read back from API to see what Jotform actually stored
      await fetchSubmissionById(submissionId);

      const data = {
        submissionId,
        registrationId,
        name: info.name || "(No name)",
        email: info.email || "(No email)",
        statusText: wasAlreadyChecked ? "Already checked (re-confirmed)" : "Checked",
        duplicate: wasAlreadyChecked
      };

      showStatus(
        wasAlreadyChecked
          ? `⚠ Already marked as checked earlier: ${data.name} (REG ID: ${registrationId})`
          : `✔ Marked as checked: ${data.name} (REG ID: ${registrationId})`,
        wasAlreadyChecked ? "error" : "ok"
      );
      showLastCheckin(data);
      addLogEntry(data);
    }

    // Initialize scanner when page loads
    window.addEventListener("load", () => {
      const html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader",
        {
          fps: 10,
          qrbox: { width: 260, height: 260 }
        },
        false
      );
      html5QrcodeScanner.render(onScanSuccess);
    });
  </script>
</body>
</html>
